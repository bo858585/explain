# Осваивая EXPLAIN

***Наброски перевода***

###1. Лицензия на слайды
- Creative Common BY-NC-SA
- You are free
  - to Share
  - to Remix
- Under the following conditions
  - Attribution
  - Noncommercial
  - Share Alike

###2. Автор
- Guillaume Lelarge
- Work
  - CTO of Dalibo
  - email: guillaume.lelarge@dalibo.com
- Community
  - pgAdmin, the french documentation, pgconf.eu organization, vice-treasurer
of PostgreSQL Europe, etc.
  - email: guillaume@lelarge.info
  - twitter: @g_lelarge

###3. Осваивая EXPLAIN
- EXPLAIN - немного жутковатая команда
- Но Вам нужно только несколько подсказок, чтобы понять, как она работает
- Об этом здесь и пойдет речь
  - понимайте
  - используйте
  - и полюбите ее

EXPLAIN - очень симпатичная команда, которая может выдать вам много информации, но зачастую непросто понять, что же делать со всей этой информацией. Это довольно досадно, потому что есть не так уж и много вещей, которые о ней нужно знать. Обо всем этом здесь пойдет речь - будет рассказано о том, как правильно интерпретировать информацию, выдаваемую этой командой, как использовать эту информацию, и исправлять ваши запросы так, чтобы они работали быстрее.

###4. Во-первых, создадим объекты
Создайте их.

```sql
$ CREATE TABLE foo (c1 integer, c2 text);
$ INSERT INTO foo
$     SELECT i, md5(random()::text)
$     FROM generate_series(1, 1000000) AS i;
```

При помощи этих двух запросов создается таблица и заполняется случайными числами. Эта таблица будет основой наших примеров.

###5. Давайте попробуем запросить из таблицы данные
```sql
$ EXPLAIN SELECT * FROM foo;
$                 QUERY PLAN
$ .....................................
$ Seq Scan on foo  (cost=0.00..18584.82
$                   rows=1025082 width=36)
```

- Cost
  - стоимость получения первой строки: 0.00
  - стоимость получения всех строк: 18584.82
  - единицы измерения стоимости - “в страницах памяти”
- Rows
  - число выданных строк
- Width
  - Cреднее средних длин записей разных столбцов (подробнее см. ниже - прим. пер.)
  - в байтах

В PostgreSQL таблицу можно читать многими способами. Наиболее простой способ - читать таблицу последовательно, блок за блоком.

В плане выполнения это отражено. У вас также есть некоторая статистическая информация, предоставляемая планировщиком.

Первое число из диапазона cost - стоимость получения первой строки таблицы. Второе число - стоимость получения всех строк в результате последовательного сканирования таблицы. Помните, что эта стоимость измеряется не во временных единицах, а в страницах памяти. То есть, стоимость считывания одной страницы по умолчанию равна 1.0.

Число строк rows это число строк таблицы, которое планировщик ожидает получить при
последовательном сканировании.

Width - Cумма средних длин записей столбцов результирующей выборки (подробнее см. ниже).

Нужно добавить, что число строк rows только приблизительно равно числу строк, считанному реально. Отличия небольшие, но они могут возникнуть, например, при одновременной работе Autovacuum Daemon и вставок (INSERT’s) в таблицу.

###6. Обновим статистику по таблице

```sql
$ ANALYZE foo;
$ EXPLAIN SELECT * FROM foo;
$                 QUERY PLAN
$ ........................................
$ Seq Scan on foo  (cost=0.00..18334.00
$                   rows=1000000 width=37)
```

- Теперь количество строк верное.
- Но как же считается статистика?

Нам необходимо обновить статистику по таблице и для этого мы вызываем команду ANALYZE. Если необходима статистика только по одной таблице foo, указывается ее название, но это необязательно.

Если после завершения ANALYZE попробовать выполнить команду EXPLAIN, статистика в планировщике уже будет обновлена. Количество строк rows верное, сумма средних длин записей столбцов выборки width стала немного больше, а страничная стоимость cost несколько ниже (стоимость зависит от количества строк, от суммы средних длин записей столбцов width она не зависит (?)).

Все это понятно, но как вся эта информация высчитывается? Почему ANALYZE важна здесь?

###7. Что делает ANALYZE?
- Считывает некоторое количество случайных строк таблицы.
  - это число равно 300*default_statistics_target
- Вычисляет некоторую статистику по значениям из каждого столбца таблицы в этих строках.
- Считает некоторые общие статистические параметры, гистограмму на их основе
  - парамаетры зависят от default_statistics_target
  - могут быть настроены для каждого столбца
-  Сохраняет статистику по столбцам в каталоге pg_statistic
- Посмотрите pg_stats view
  - прост для чтения
  - много довольно интересной информации

ANALYZE читает указанную часть каждой таблицы из базы данных (если вы укажете конкретную таблицу, он будет читать только ее). Выборка из таблицы производится случайным образом. Ее размер зависит от значения параметра default_statistics_target - в 300 раз больше этого значения. По умолчанию, default_statistics_target равен 100 (с версии 8.4), так что будут считаны 30к случайных строк таблицы.

Вся статистическая информация хранится в системном каталоге pg_statistic. Его довольно трудно читать, для удобства есть симпатичный pg_stats view. Мы увидим некоторые из его столбцов дальше по тексту.

Сейчас разберемся, как планировщик вычисляет статистическую информацию (под чертой), выданную в EXPLAIN.

###8. Width
```sql
$ SELECT sum(avg_width) AS width
$ FROM pg_stats
$ WHERE tablename='foo';
$ width  
$ -----
$    37
```

 - (avg_width - из стандартной документации "средняя длина в байтах записей столбца" — прим. пер. http://www.postgresql.org/docs/8.4/static/view-pg-stats.html  )
Width - сумма по всем столбцам средних длин записей столбцов результирующей выборки.
 - The lesser, the better

Width -  это сумма средних длин ячеек каждого столбца. Так как ANALYZE вычисляет среднюю длину полученных ячеек, принадлежащих каждому столбцу результирующей таблицы, то мы можем получить эту информацию путем суммирования этих значений для каждого столбца таблицы. SQL-запрос в примере выше считает эту сумму.
